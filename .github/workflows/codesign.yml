name: Build and Sign EXE with DigiCert STM

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-sign:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build test EXE
        shell: pwsh
        run: |
          dotnet new console -n HelloSTM -o HelloSTM
          dotnet publish HelloSTM -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o out
          if (!(Test-Path "out\HelloSTM.exe")) {
            Get-ChildItem -Recurse out
            throw "Expected out\HelloSTM.exe not found."
          }

      # Marketplace pattern: write P12 to runner temp, then pass creds via env
      - name: Setup SM_CLIENT_CERT_FILE from base64 secret data
        shell: bash
        run: |
          export SM_CLIENT_CERT_FILE="${RUNNER_TEMP}/sm_client_cert.p12"
          echo "${{ secrets.SM_CLIENT_CERT_FILE_B64 }}" | tr -d '\r\n' | base64 --decode > "${SM_CLIENT_CERT_FILE}"
          echo "SM_CLIENT_CERT_FILE=${SM_CLIENT_CERT_FILE}" >> $GITHUB_ENV

      # IMPORTANT: Provide input + keypair-alias so the action invokes smctl itself
      - name: Setup Software Trust Manager + Sign
        uses: digicert/code-signing-software-trust-action@main
        with:
          simple-signing-mode: true
          input: out/HelloSTM.exe
          keypair-alias: PrivateKeyPair
        env:
          SM_HOST: ${{ vars.SM_HOST }}
          SM_API_KEY: ${{ secrets.SM_API_KEY }}
          SM_CLIENT_CERT_FILE: ${{ env.SM_CLIENT_CERT_FILE }}
          SM_CLIENT_CERT_PASSWORD: ${{ secrets.SM_CLIENT_CERT_PASSWORD }}
